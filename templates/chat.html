{% extends "base.html" %}
{% block content %}
<div class="sidebar">
  <h2>💬 Conversas</h2>
  
  <div class="instance-selector">
    <form method="get" action="{{ url_for('chat') }}">
      <select name="instance" onchange="this.form.submit()">
        <option value="">🔍 Selecione a instância</option>
        {% for inst in instances %}
          <option value="{{ inst }}" {% if inst == instance %}selected{% endif %}>{{ inst }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
  
  <div class="conversations-list">
    <ul>
      {% for conv in conversations %}
        <li class="conversation-item">
          <a href="{{ url_for('chat', instance=instance, remoteJid=conv.remotejid) }}">
            <div class="conversation-name">{{ conv.remotejid.split('@')[0] }}</div>
            <div class="conversation-time">{{ conv.last_date.strftime("%d/%m/%Y %H:%M") }}</div>
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="chat-container">
  <div class="chat-header">
    {% if remoteJid %}
      💬 Conversa com <strong>{{ remoteJid.split('@')[0] }}</strong>
    {% else %}
      👋 Selecione uma conversa para começar
    {% endif %}
  </div>
  
  <div id="chat" class="chat-area">
    {% if messages %}
      {% for msg in messages %}
        <div class="chat-bubble {% if msg.sender == 'ai' %}chat-right{% else %}chat-left{% endif %}">
          {{ msg.message }}
          <div class="timestamp">{{ msg.date_time.strftime("%d/%m/%Y %H:%M") }}</div>
        </div>
      {% endfor %}
    {% elif remoteJid %}
      <div class="empty-state">
        <h3>🤔 Nenhuma mensagem encontrada</h3>
        <p>Esta conversa ainda não possui mensagens</p>
      </div>
    {% else %}
      <div class="empty-state">
        <h3>✨ Bem-vindo ao Visualizador de Chats</h3>
        <p>Selecione uma instância e conversa na barra lateral para começar</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
function refreshMessages() {
  const instance = "{{ instance }}";
  const remoteJid = "{{ remoteJid }}";
  if (!instance || !remoteJid) return;
  
  $.getJSON(`/messages?instance=${instance}&remoteJid=${remoteJid}`, function(data) {
    let html = "";
    if (data.length === 0) {
      html = `<div class="empty-state">
        <h3>🤔 Nenhuma mensagem encontrada</h3>
        <p>Esta conversa ainda não possui mensagens</p>
      </div>`;
    } else {
      data.forEach(msg => {
        html += `<div class="chat-bubble ${msg.sender === 'ai' ? 'chat-right' : 'chat-left'}">
          ${msg.message}
          <div class="timestamp">${msg.date_time}</div>
        </div>`;
      });
    }
    $("#chat").html(html);
    
    // Auto scroll to bottom
    const chatArea = document.getElementById('chat');
    chatArea.scrollTop = chatArea.scrollHeight;
  }).fail(function() {
    $("#chat").html(`<div class="empty-state">
      <h3>❌ Erro ao carregar mensagens</h3>
      <p>Tente novamente em alguns segundos</p>
    </div>`);
  });
}

// Auto-scroll to bottom on page load
$(document).ready(function() {
  const chatArea = document.getElementById('chat');
  chatArea.scrollTop = chatArea.scrollHeight;
});

setInterval(refreshMessages, 5000);
</script>
{% endblock %}